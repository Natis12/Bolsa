name: Limpieza por Cantidad

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  delete-old-reports:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mantener solo los Ãºltimos 20 informes
        shell: python
        run: |
          import os
          
          # CONFIGURACIÃ“N: CuÃ¡ntos informes quieres guardar
          KEEP_LAST = 20  
          
          print(f"ðŸ§¹ Iniciando limpieza. Se mantendrÃ¡n solo los {KEEP_LAST} informes mÃ¡s recientes.")
          
          # Listar y ordenar archivos (por nombre, que incluye la fecha)
          archivos = [f for f in os.listdir('.') if f.startswith("informe-") and f.endswith(".html")]
          archivos.sort() # Ordena del mÃ¡s antiguo al mÃ¡s nuevo
          
          # Identificar cuÃ¡les sobran
          if len(archivos) > KEEP_LAST:
              sobran = archivos[:-KEEP_LAST] # Todos menos los Ãºltimos 20
              print(f"âš ï¸ Se han encontrado {len(archivos)} informes. Borrando {len(sobran)} antiguos...")
              
              for f in sobran:
                  print(f"ðŸ—‘ï¸ Eliminando: {f}")
                  os.remove(f)
              
              # Guardamos variable para el commit
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f"BORRADOS={len(sobran)}\n")
          else:
              print(f"âœ… Todo limpio. Hay {len(archivos)} informes (LÃ­mite: {KEEP_LAST}).")
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f"BORRADOS=0\n")

      - name: Commit y Push cambios
        if: env.BORRADOS > 0
        run: |
          git config --global user.name "Bot Limpieza"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Auto limpieza: Exceso de informes eliminado"
          git push
