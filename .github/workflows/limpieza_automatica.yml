name: Limpieza Fiable (Python)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  delete-old-reports:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Borrar informes antiguos seg√∫n fecha en nombre
        shell: python
        run: |
          import os
          import re
          from datetime import datetime, timedelta

          # CONFIGURACI√ìN: Borrar si tiene m√°s de X d√≠as
          MAX_DIAS = 1  # <--- CAMBIA ESTO A 1 PARA PROBAR CON LOS DE AYER
          ahora = datetime.utcnow()

          print(f"üßπ Iniciando limpieza. Borrando archivos anteriores a {MAX_DIAS} dias.")
          
          archivos_borrados = 0
          
          for archivo in os.listdir('.'):
              if archivo.startswith("informe-") and archivo.endswith(".html"):
                  # Intentamos extraer fecha del nombre: informe-DD-MM-YYYY-HH-MM.html
                  match = re.search(r'informe-(\d{2})-(\d{2})-(\d{4})', archivo)
                  if match:
                      dia, mes, anio = map(int, match.groups())
                      fecha_archivo = datetime(anio, mes, dia)
                      
                      # Calculamos antig√ºedad
                      edad = (ahora - fecha_archivo).days
                      
                      if edad >= MAX_DIAS:
                          print(f"üóëÔ∏è Eliminando {archivo} (Edad: {edad} d√≠as)")
                          os.remove(archivo)
                          archivos_borrados += 1
          
          print(f"üìä Total borrados: {archivos_borrados}")
          
          # Guardamos variable para el siguiente paso
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"BORRADOS={archivos_borrados}\n")

      - name: Commit y Push cambios
        if: env.BORRADOS > 0
        run: |
          git config --global user.name "Bot Limpieza"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Auto limpieza: ${BORRADOS} informes antiguos eliminados"
          git push
